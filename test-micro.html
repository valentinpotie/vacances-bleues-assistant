<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Vacances Bleues - Assistant Vocal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(214.3 31.8% 91.4%)",
                        input: "hsl(214.3 31.8% 91.4%)",
                        ring: "hsl(221.2 83.2% 53.3%)",
                        background: "hsl(0 0% 100%)",
                        foreground: "hsl(222.2 84% 4.9%)",
                        primary: {
                            DEFAULT: "hsl(221.2 83.2% 53.3%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        secondary: {
                            DEFAULT: "hsl(210 40% 96.1%)",
                            foreground: "hsl(222.2 47.4% 11.2%)",
                        },
                        destructive: {
                            DEFAULT: "hsl(0 84.2% 60.2%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        muted: {
                            DEFAULT: "hsl(210 40% 96.1%)",
                            foreground: "hsl(215.4 16.3% 46.9%)",
                        },
                        accent: {
                            DEFAULT: "hsl(210 40% 96.1%)",
                            foreground: "hsl(222.2 47.4% 11.2%)",
                        },
                        card: {
                            DEFAULT: "hsl(0 0% 100%)",
                            foreground: "hsl(222.2 84% 4.9%)",
                        },
                        success: {
                            DEFAULT: "hsl(142.1 76.2% 36.3%)",
                            foreground: "hsl(355.7 100% 97.3%)",
                        },
                    },
                    borderRadius: {
                        lg: "0.5rem",
                        md: "calc(0.5rem - 2px)",
                        sm: "calc(0.5rem - 4px)",
                    },
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for specific elements */
        .shadow-card {
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .shadow-card-hover {
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .shadow-card-hover:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }

        /* Custom scrollbar for transcript and logs */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: hsl(210 40% 96.1%);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: hsl(215.4 16.3% 46.9%);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: hsl(215.4 16.3% 36.9%);
        }

        /* Gradient animation for volume bar */
        .volume-gradient {
            background: linear-gradient(90deg,
                hsl(142.1 76.2% 36.3%) 0%,
                hsl(45 93% 47%) 50%,
                hsl(0 84.2% 60.2%) 100%);
        }

        /* Logo animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .logo-float {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Header -->
        <header class="text-center mb-8 animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl mb-4 logo-float shadow-lg">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Vacances Bleues</h1>
            <p class="text-lg text-gray-600">Test de l'assistant vocal de r√©servation</p>
        </header>

        <!-- Status Card -->
        <div class="bg-white rounded-lg shadow-card p-6 mb-6 animate-fade-in border border-gray-200">
            <div id="status" class="flex items-center justify-center gap-3">
                <span id="statusIndicator" class="relative flex h-4 w-4">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span>
                </span>
                <span id="statusText" class="text-lg font-semibold text-gray-700">D√©connect√©</span>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Left Column -->
            <div class="space-y-6">

                <!-- Controls Card -->
                <div class="bg-white rounded-lg shadow-card p-6 border border-gray-200 animate-fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                        </svg>
                        Contr√¥les
                    </h2>
                    <div class="space-y-3">
                        <button id="startBtn" class="w-full inline-flex items-center justify-center gap-2 rounded-lg text-base font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:from-green-600 hover:to-emerald-700 h-12 px-6 py-3 shadow-lg shadow-green-500/30 hover:shadow-xl hover:shadow-green-500/40 hover:-translate-y-0.5 active:translate-y-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            D√©marrer l'appel test
                        </button>
                        <button id="stopBtn" disabled class="w-full inline-flex items-center justify-center gap-2 rounded-lg text-base font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-to-r from-red-500 to-rose-600 text-white hover:from-red-600 hover:to-rose-700 h-12 px-6 py-3 shadow-lg shadow-red-500/30 hover:shadow-xl hover:shadow-red-500/40 hover:-translate-y-0.5 active:translate-y-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                            </svg>
                            Terminer l'appel
                        </button>
                    </div>

                    <!-- Volume Meter -->
                    <div class="mt-6">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-gray-700">Niveau du microphone</label>
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 0m-2.828-9.9a9 9 0 0112.728 0"></path>
                            </svg>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                            <div id="volumeBar" class="h-full volume-gradient transition-all duration-100 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Card -->
                <div class="bg-white rounded-lg shadow-card p-6 border border-gray-200 animate-fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Configuration
                    </h2>
                    <div class="space-y-3">
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                            <svg class="w-5 h-5 text-gray-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-700 mb-1">Cl√© API</p>
                                <code id="apiKeyStatus" class="text-xs text-gray-600 bg-white px-2 py-1 rounded border border-gray-200 break-all">Non configur√©e</code>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                            <svg class="w-5 h-5 text-gray-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-700 mb-1">Serveur</p>
                                <code class="text-xs text-gray-600 bg-white px-2 py-1 rounded border border-gray-200">WebSocket direct OpenAI</code>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                            <svg class="w-5 h-5 text-gray-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-700 mb-1">Micro</p>
                                <code id="micStatus" class="text-xs text-gray-600 bg-white px-2 py-1 rounded border border-gray-200">En attente</code>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                            <svg class="w-5 h-5 text-gray-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 0m-2.828-9.9a9 9 0 0112.728 0"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-700 mb-1">Audio</p>
                                <code id="audioStatus" class="text-xs text-gray-600 bg-white px-2 py-1 rounded border border-gray-200">En attente</code>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex gap-2">
                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div class="text-xs text-amber-800">
                                <p class="font-semibold mb-1">Important</p>
                                <p>Cette page n√©cessite une connexion internet stable et une cl√© API OpenAI valide avec acc√®s √† l'API Realtime.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column -->
            <div class="space-y-6">

                <!-- Conversation Card -->
                <div class="bg-white rounded-lg shadow-card border border-gray-200 animate-fade-in">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                            </svg>
                            Conversation
                        </h2>
                    </div>
                    <div id="transcriptContent" class="p-4 max-h-96 overflow-y-auto custom-scrollbar space-y-3">
                        <div class="message system p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg animate-slide-in">
                            <div class="label flex items-center gap-2 text-xs font-semibold text-blue-700 uppercase tracking-wide mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Syst√®me
                            </div>
                            <div class="text-sm text-gray-700">Cliquez sur "D√©marrer l'appel test" pour commencer...</div>
                        </div>
                    </div>
                </div>

                <!-- Logs Card -->
                <div class="bg-gray-900 rounded-lg shadow-card border border-gray-800 animate-fade-in">
                    <div class="p-6 border-b border-gray-800">
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Logs techniques
                        </h2>
                    </div>
                    <div id="logsContent" class="p-4 max-h-64 overflow-y-auto custom-scrollbar font-mono text-xs space-y-1">
                        <!-- Logs will be inserted here -->
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = localStorage.getItem('openai_api_key') || prompt('Entrez votre cl√© API OpenAI (sk-proj-...):');

        if (API_KEY && API_KEY.startsWith('sk-')) {
            localStorage.setItem('openai_api_key', API_KEY);
            document.getElementById('apiKeyStatus').textContent = API_KEY.substring(0, 20) + '...';
        } else {
            alert('Cl√© API invalide. Rechargez la page et entrez une cl√© valide.');
        }

        // Variables globales
        let peerConnection = null;
        let dataChannel = null;
        let audioElement = null;

        // √âl√©ments DOM
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const transcriptContent = document.getElementById('transcriptContent');
        const logsContent = document.getElementById('logsContent');
        const volumeBar = document.getElementById('volumeBar');
        const micStatus = document.getElementById('micStatus');
        const audioStatus = document.getElementById('audioStatus');

        // Fonction pour ajouter un log
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsContent.insertBefore(logEntry, logsContent.firstChild);

            // Garder seulement les 50 derniers logs
            while (logsContent.children.length > 50) {
                logsContent.removeChild(logsContent.lastChild);
            }
        }

        // Fonction pour ajouter un message dans la conversation
        function addMessage(text, type = 'system') {
            const message = document.createElement('div');
            message.className = `message ${type}`;

            const label = document.createElement('div');
            label.className = 'label';
            label.textContent = type === 'user' ? 'üë§ Vous' :
                               type === 'assistant' ? 'ü§ñ Assistant' :
                               '‚ÑπÔ∏è Syst√®me';

            const content = document.createElement('div');
            content.textContent = text;

            message.appendChild(label);
            message.appendChild(content);
            transcriptContent.appendChild(message);

            // Auto-scroll
            transcriptContent.scrollTop = transcriptContent.scrollHeight;
        }

        // Fonction pour mettre √† jour le statut
        function setStatus(status, text) {
            statusDiv.className = `status ${status}`;
            statusText.textContent = text;
        }

        // D√©marrer l'appel
        startBtn.addEventListener('click', async () => {
            try {
                addLog('D√©marrage de la session...', 'info');
                setStatus('connecting', 'Connexion en cours...');
                startBtn.disabled = true;

                // Cr√©er une session √©ph√©m√®re
                addLog('Cr√©ation de la session √©ph√©m√®re...', 'info');
                const tokenResponse = await fetch('https://api.openai.com/v1/realtime/sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-realtime-preview-2024-12-17',
                        voice: 'alloy',
                        instructions: `Tu es un assistant de r√©servation pour la cha√Æne d'h√¥tels Vacances Bleues.

Ton r√¥le est d'aider les clients √† r√©server des chambres d'h√¥tel de mani√®re chaleureuse et professionnelle.

IMPORTANT: Tu dois TOUJOURS parler en fran√ßais.

Processus de r√©servation:
1. Accueille chaleureusement le client
2. Demande les dates d'arriv√©e et de d√©part souhait√©es
3. Demande le nombre de personnes
4. Propose les types de chambres disponibles selon les besoins
5. Collecte les informations personnelles (nom, pr√©nom, t√©l√©phone, email)
6. Demande s'il y a des demandes sp√©ciales
7. R√©capitule la r√©servation
8. Confirme la r√©servation (pour le test, dis juste que la r√©servation est confirm√©e)

Types de chambres disponibles:
- Chambre Standard (2 personnes) - √Ä partir de 89‚Ç¨/nuit
- Chambre Familiale (4 personnes) - √Ä partir de 139‚Ç¨/nuit
- Suite Vue Mer (2 personnes) - √Ä partir de 179‚Ç¨/nuit

Sois naturel, sympathique et efficace. Pose une question √† la fois pour ne pas submerger le client.`,
                        modalities: ['text', 'audio'],
                        turn_detection: { type: 'server_vad' }
                    }),
                });

                if (!tokenResponse.ok) {
                    const error = await tokenResponse.text();
                    throw new Error(`Erreur session: ${error}`);
                }

                const data = await tokenResponse.json();
                addLog('Session cr√©√©e avec succ√®s', 'success');
                addLog(`Session ID: ${data.id}`, 'info');
                console.log('R√©ponse compl√®te de l\'API:', data);

                // Cr√©er PeerConnection
                addLog('Configuration WebRTC...', 'info');
                peerConnection = new RTCPeerConnection();

                // Cr√©er √©l√©ment audio
                audioElement = document.createElement('audio');
                audioElement.autoplay = true;
                audioStatus.textContent = 'Pr√™t';

                // G√©rer les pistes audio
                peerConnection.ontrack = (event) => {
                    addLog('Flux audio re√ßu', 'success');
                    audioElement.srcObject = event.streams[0];
                };

                // Ajouter le micro
                addLog('Demande acc√®s au microphone...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addLog('Microphone activ√©', 'success');
                micStatus.textContent = 'Actif ‚úÖ';

                stream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, stream);
                });

                // Visualisation du volume
                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                source.connect(analyser);
                analyser.fftSize = 256;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function updateVolume() {
                    if (peerConnection && peerConnection.connectionState === 'connected') {
                        analyser.getByteFrequencyData(dataArray);
                        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                        volumeBar.style.width = `${Math.min(100, average)}%`;
                        requestAnimationFrame(updateVolume);
                    }
                }
                updateVolume();

                // Data channel pour les √©v√©nements
                dataChannel = peerConnection.createDataChannel('oai-events');

                dataChannel.addEventListener('open', () => {
                    addLog('Canal de donn√©es ouvert', 'success');
                    setStatus('connected', '‚úÖ Connect√© - Parlez maintenant !');
                    stopBtn.disabled = false;

                    // Envoyer le message d'accueil
                    const greeting = {
                        type: 'response.create',
                        response: {
                            instructions: 'Dis: Bonjour et bienvenue chez Vacances Bleues ! Je suis votre assistant de r√©servation. Comment puis-je vous aider aujourd\'hui ?'
                        }
                    };
                    dataChannel.send(JSON.stringify(greeting));
                    addLog('Message d\'accueil envoy√©', 'info');
                });

                dataChannel.addEventListener('message', (event) => {
                    try {
                        const msg = JSON.parse(event.data);

                        // Log tous les √©v√©nements
                        addLog(`Event: ${msg.type}`, 'info');

                        // G√©rer les transcriptions
                        if (msg.type === 'conversation.item.created') {
                            if (msg.item?.role === 'user' && msg.item?.content) {
                                const text = msg.item.content
                                    .filter(c => c.type === 'input_text')
                                    .map(c => c.text)
                                    .join('');
                                if (text) {
                                    addMessage(text, 'user');
                                    addLog(`Utilisateur: ${text}`, 'info');
                                }
                            } else if (msg.item?.role === 'assistant' && msg.item?.content) {
                                const text = msg.item.content
                                    .filter(c => c.type === 'text')
                                    .map(c => c.text)
                                    .join('');
                                if (text) {
                                    addMessage(text, 'assistant');
                                    addLog(`Assistant: ${text}`, 'success');
                                }
                            }
                        }

                        // G√©rer les r√©ponses audio
                        if (msg.type === 'response.audio_transcript.done') {
                            addMessage(msg.transcript, 'assistant');
                            addLog(`Assistant: ${msg.transcript}`, 'success');
                        }

                        // G√©rer les transcriptions utilisateur
                        if (msg.type === 'conversation.item.input_audio_transcription.completed') {
                            addMessage(msg.transcript, 'user');
                            addLog(`Utilisateur: ${msg.transcript}`, 'info');
                        }

                    } catch (e) {
                        addLog(`Erreur parsing: ${e.message}`, 'error');
                    }
                });

                // Cr√©er et envoyer l'offre
                addLog('Cr√©ation de l\'offre SDP...', 'info');
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Envoyer l'offre √† OpenAI
                addLog('Envoi de l\'offre √† OpenAI...', 'info');
                const sdpUrl = `https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17`;
                addLog(`URL SDP: ${sdpUrl}`, 'info');
                const sdpResponse = await fetch(sdpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/sdp',
                        'Authorization': `Bearer ${data.client_secret.value}`,
                        'OpenAI-Beta': 'realtime=v1',
                    },
                    body: offer.sdp,
                });

                if (!sdpResponse.ok) {
                    throw new Error(`Erreur SDP: ${sdpResponse.statusText}`);
                }

                const answerSdp = await sdpResponse.text();
                addLog('R√©ponse SDP re√ßue', 'success');

                await peerConnection.setRemoteDescription({
                    type: 'answer',
                    sdp: answerSdp,
                });

                addLog('Connexion √©tablie !', 'success');
                addMessage('Connexion √©tablie ! L\'assistant va vous parler...', 'system');

            } catch (error) {
                addLog(`Erreur: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);

                // Si c'est une erreur de fetch, montrer plus de d√©tails
                if (error instanceof TypeError && error.message.includes('Load failed')) {
                    addLog('Erreur de chargement - V√©rifiez votre connexion internet', 'error');
                    addLog('Ou probl√®me CORS avec l\'API OpenAI', 'warning');
                }

                setStatus('disconnected', '‚ùå Erreur de connexion');
                alert(`Erreur: ${error.message}\n\nV√©rifiez la console (F12) pour plus de d√©tails.`);
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });

        // Arr√™ter l'appel
        stopBtn.addEventListener('click', () => {
            addLog('Fermeture de la connexion...', 'info');

            if (dataChannel) {
                dataChannel.close();
            }

            if (peerConnection) {
                peerConnection.close();
            }

            if (audioElement) {
                audioElement.srcObject = null;
            }

            setStatus('disconnected', 'D√©connect√©');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            micStatus.textContent = 'Inactif';
            audioStatus.textContent = 'Inactif';
            volumeBar.style.width = '0%';

            addLog('Connexion ferm√©e', 'info');
            addMessage('Appel termin√©. Merci d\'avoir test√© l\'assistant Vacances Bleues !', 'system');
        });

        // Log initial
        addLog('Page charg√©e - Pr√™t √† d√©marrer', 'success');
    </script>

    <style>
        /* Message styles */
        .message {
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            @apply p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg;
        }

        .message.user .label {
            @apply flex items-center gap-2 text-xs font-semibold text-blue-700 uppercase tracking-wide mb-2;
        }

        .message.user div:last-child {
            @apply text-sm text-gray-700;
        }

        .message.assistant {
            @apply p-4 bg-purple-50 border-l-4 border-purple-500 rounded-lg;
        }

        .message.assistant .label {
            @apply flex items-center gap-2 text-xs font-semibold text-purple-700 uppercase tracking-wide mb-2;
        }

        .message.assistant div:last-child {
            @apply text-sm text-gray-700;
        }

        .message.system {
            @apply p-4 bg-amber-50 border-l-4 border-amber-500 rounded-lg;
        }

        .message.system .label {
            @apply flex items-center gap-2 text-xs font-semibold text-amber-700 uppercase tracking-wide mb-2;
        }

        .message.system div:last-child {
            @apply text-sm text-gray-700 italic;
        }

        /* Log entry styles */
        .log-entry.info {
            @apply text-blue-400;
        }

        .log-entry.success {
            @apply text-green-400;
        }

        .log-entry.error {
            @apply text-red-400;
        }

        .log-entry.warning {
            @apply text-yellow-400;
        }

        /* Status styles */
        .status.connecting #statusIndicator span:first-child {
            @apply bg-yellow-400;
        }

        .status.connecting #statusIndicator span:last-child {
            @apply bg-yellow-500;
        }

        .status.connected #statusIndicator span:first-child {
            @apply bg-green-400;
        }

        .status.connected #statusIndicator span:last-child {
            @apply bg-green-500;
        }

        .status.disconnected #statusIndicator span:first-child {
            @apply bg-red-400;
        }

        .status.disconnected #statusIndicator span:last-child {
            @apply bg-red-500;
        }
    </style>
</body>
</html>
